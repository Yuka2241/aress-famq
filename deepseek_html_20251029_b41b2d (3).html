<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aress FamQ - Majestic RP</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #ff6b35; --dark: #0c0c0c; --card: rgba(30,30,30,0.9);
            --text-light: #b0b0b0; --text-white: #fff; --success: #00b09b; --error: #ff416c;
        }
        body {
            background: linear-gradient(135deg, var(--dark) 0%, #1a1a1a 100%);
            color: var(--text-white); font-family: 'Segoe UI', sans-serif;
            min-height: 100vh; line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        
        /* Header */
        header {
            background: rgba(15,15,15,0.98); padding: 15px 0;
            border-bottom: 1px solid rgba(255,107,53,0.3); position: sticky; top: 0;
        }
        .header-content {
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 15px;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon {
            width: 45px; height: 45px; background: linear-gradient(135deg, var(--primary), #f7931e);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2em; box-shadow: 0 0 20px rgba(255,107,53,0.5);
        }
        .logo-text {
            font-size: 2em; font-weight: 800;
            background: linear-gradient(135deg, var(--primary), #f7931e);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        
        /* Navigation */
        .nav-buttons {
            display: flex; gap: 10px; margin-top: 15px; justify-content: center;
            flex-wrap: wrap; width: 100%;
        }
        .nav-button {
            background: rgba(255,107,53,0.1); color: var(--primary);
            border: 1px solid var(--primary); padding: 12px 20px; border-radius: 20px;
            cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center;
            gap: 8px; font-weight: 600; flex: 1; min-width: 120px; justify-content: center;
        }
        .nav-button:hover { background: var(--primary); color: #000; }
        
        /* Main Content */
        .content-section { display: none; padding: 40px 20px; }
        .content-section.active { display: block; }
        .main-content { text-align: center; }
        .welcome-text {
            font-size: 2.5em; margin-bottom: 20px; font-weight: 800;
            background: linear-gradient(135deg, #fff, #ccc); -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stats {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin: 40px 0;
        }
        .stat-card {
            background: var(--card); border: 1px solid #333; border-radius: 15px;
            padding: 25px; transition: all 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        
        /* Forms */
        .modal { display: none; position: fixed; z-index: 1000; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.8); padding: 20px; }
        .modal-content {
            background: #1a1a1a; margin: 5% auto; padding: 30px; border-radius: 15px;
            max-width: 400px; border: 2px solid var(--primary); position: relative;
        }
        .close { color: var(--primary); float: right; font-size: 28px; cursor: pointer; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group input, .form-group textarea {
            width: 100%; padding: 12px; background: rgba(40,40,40,0.8);
            border: 1px solid #444; border-radius: 8px; color: var(--text-white);
            font-size: 1em;
        }
        .submit-btn {
            background: var(--primary); color: white; border: none; padding: 12px;
            border-radius: 20px; cursor: pointer; width: 100%; font-weight: 600;
        }
        
        /* Admin */
        .admin-section { background: var(--card); border-radius: 15px; padding: 25px; margin-bottom: 20px; }
        .user-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .user-card { background: rgba(40,40,40,0.6); border-radius: 10px; padding: 15px; position: relative; }
        
        /* Notifications */
        .notification {
            position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 10px;
            color: white; font-weight: bold; z-index: 1001; transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .notification.show { transform: translateX(0); }
        .notification.success { background: var(--success); }
        .notification.error { background: var(--error); }
        
        /* Subpages */
        .subpage { display: none; }
        .subpage.active { display: block; }
        .page-nav {
            display: flex; justify-content: center; gap: 10px; margin: 30px 0;
            flex-wrap: wrap;
        }
        .page-nav-button {
            background: rgba(255,107,53,0.1); color: var(--primary);
            border: 1px solid var(--primary); padding: 10px 15px; border-radius: 15px;
            cursor: pointer; transition: all 0.3s ease; font-weight: 600;
        }
        .page-nav-button.active {
            background: var(--primary); color: #000;
        }
        .page-nav-button:hover:not(.active) {
            background: rgba(255,107,53,0.3);
        }
        
        @media (max-width: 768px) {
            .header-content { flex-direction: column; text-align: center; }
            .logo-text { font-size: 1.6em; }
            .welcome-text { font-size: 2em; }
            .nav-button { min-width: 100px; padding: 10px 15px; font-size: 0.9em; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div id="notification" class="notification"></div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">AF</div>
                    <div class="logo-text">Aress FamQ</div>
                </div>
                <div class="auth-buttons" id="authButtons">
                    <button class="nav-button" onclick="openModal('loginModal')">
                        <i class="fas fa-sign-in-alt"></i>Войти
                    </button>
                    <button class="nav-button" onclick="openModal('registerModal')">
                        <i class="fas fa-user-plus"></i>Регистрация
                    </button>
                </div>
                <div class="user-info" id="userInfo" style="display: none;">
                    <span id="userName"></span>
                    <button class="nav-button" onclick="openModal('settingsModal')">
                        <i class="fas fa-cog"></i>Настройки
                    </button>
                    <button class="nav-button" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>Выйти
                    </button>
                </div>
            </div>
            <div class="nav-buttons">
                <button class="nav-button" onclick="showSection('main')">Главная</button>
                <button class="nav-button" onclick="showSection('about')">О семье</button>
                <button class="nav-button" onclick="showSection('rules')">Правила</button>
                <button class="nav-button" onclick="showSection('reviews')">Отзывы</button>
                <button class="nav-button" onclick="openModal('joinFamilyModal')">Вступить</button>
                <button class="nav-button admin-only" onclick="showSection('admin')" style="display: none;">
                    Админка
                </button>
            </div>
        </div>
    </header>

    <section id="main" class="content-section active">
        <div class="container">
            <div class="main-content">
                <h1 class="welcome-text">Aress FamQ</h1>
                <p style="color: var(--text-light); margin-bottom: 30px; font-size: 1.2em;">
                    Стань частью нашей семьи на Majestic RP!
                </p>
                <button class="submit-btn" onclick="openModal('joinFamilyModal')" style="width: auto; padding: 15px 30px;">
                    <i class="fas fa-shield-alt"></i> Присоединиться
                </button>
                <div class="stats">
                    <div class="stat-card">
                        <h3><i class="fas fa-gamepad"></i> Опыт</h3>
                        <p>Семья основана в 2025 году</p>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-user-friends"></i> Состав</h3>
                        <p>Активно набираем игроков</p>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-trophy"></i> Достижения</h3>
                        <p>Лидеры по развитию</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="about" class="content-section">
        <div class="container">
            <h2 style="text-align: center; color: var(--primary); margin-bottom: 30px;">О семье</h2>
            
            <div class="page-nav">
                <button class="page-nav-button active" onclick="showSubpage('about', 'about-1')">История</button>
                <button class="page-nav-button" onclick="showSubpage('about', 'about-2')">Цели</button>
                <button class="page-nav-button" onclick="showSubpage('about', 'about-3')">Структура</button>
                <button class="page-nav-button" onclick="showSubpage('about', 'about-4')">Достижения</button>
                <button class="page-nav-button" onclick="showSubpage('about', 'about-5')">Будущее</button>
            </div>
            
            <div id="about-1" class="subpage active">
                <div class="admin-section">
                    <h3>История создания семьи</h3>
                    <p>Aress FamQ была основана в 2025 году группой опытных игроков, которые стремились создать не просто семью, а настоящее сообщество единомышленников.</p>
                    <p>Начав с небольшой группы из 5 человек, мы постепенно развивались и расширялись, привлекая талантливых игроков со всего проекта Majestic RP.</p>
                    <p>За время существования семьи мы прошли через множество испытаний, но всегда оставались верны нашим принципам и ценностям.</p>
                </div>
            </div>
            
            <div id="about-2" class="subpage">
                <div class="admin-section">
                    <h3>Наши цели и миссия</h3>
                    <p>Основная цель Aress FamQ - создание сильного и сплоченного сообщества, где каждый член семьи может развиваться и достигать успеха.</p>
                    <ul style="margin-left: 20px; color: var(--text-light); margin-top: 15px;">
                        <li>Создание благоприятной атмосферы для всех членов</li>
                        <li>Развитие игровых навыков каждого участника</li>
                        <li>Достижение лидерских позиций на проекте</li>
                        <li>Поддержка новых игроков и помощь в адаптации</li>
                        <li>Создание наследия, которое переживет текущий проект</li>
                    </ul>
                </div>
            </div>
            
            <div id="about-3" class="subpage">
                <div class="admin-section">
                    <h3>Структура семьи</h3>
                    <p>В Aress FamQ существует четкая иерархическая структура, которая обеспечивает эффективное управление и координацию действий:</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                        <div class="user-card">
                            <h4 style="color: var(--primary);">Основатели</h4>
                            <p>Создатели семьи, определяющие стратегию развития</p>
                        </div>
                        <div class="user-card">
                            <h4 style="color: var(--primary);">Советники</h4>
                            <p>Опытные игроки, помогающие в управлении семьей</p>
                        </div>
                        <div class="user-card">
                            <h4 style="color: var(--primary);">Ветераны</h4>
                            <p>Долгосрочные члены семьи с особыми привилегиями</p>
                        </div>
                        <div class="user-card">
                            <h4 style="color: var(--primary);">Активные члены</h4>
                            <p>Основной состав семьи, участвующий во всех активностях</p>
                        </div>
                        <div class="user-card">
                            <h4 style="color: var(--primary);">Новички</h4>
                            <p>Новые участники, проходящие период адаптации</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="about-4" class="subpage">
                <div class="admin-section">
                    <h3>Наши достижения</h3>
                    <p>За время существования Aress FamQ мы достигли значительных успехов:</p>
                    <ul style="margin-left: 20px; color: var(--text-light); margin-top: 15px;">
                        <li>Топ-5 самых влиятельных семей на проекте</li>
                        <li>Более 100 успешно завершенных ивентов</li>
                        <li>Создание собственной экономической системы</li>
                        <li>Разработка уникальных тактик и стратегий</li>
                        <li>Подготовка более 50 новых игроков</li>
                        <li>Создание сильного сообщества с активной дискорд-группой</li>
                        <li>Участие в разработке контента для проекта</li>
                    </ul>
                </div>
            </div>
            
            <div id="about-5" class="subpage">
                <div class="admin-section">
                    <h3>Планы на будущее</h3>
                    <p>Мы постоянно развиваемся и строим амбициозные планы:</p>
                    <ul style="margin-left: 20px; color: var(--text-light); margin-top: 15px;">
                        <li>Расширение семьи до 100+ активных членов</li>
                        <li>Создание собственного контента и модов</li>
                        <li>Организация масштабных ивентов для всего проекта</li>
                        <li>Развитие партнерских отношений с другими семьями</li>
                        <li>Создание образовательной программы для новичков</li>
                        <li>Участие в конкурсах и чемпионатах проекта</li>
                        <li>Разработка собственного стиля и уникальной идентичности</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <section id="rules" class="content-section">
        <div class="container">
            <h2 style="text-align: center; color: var(--primary); margin-bottom: 30px;">Правила семьи</h2>
            
            <div class="page-nav">
                <button class="page-nav-button active" onclick="showSubpage('rules', 'rules-1')">Основные</button>
                <button class="page-nav-button" onclick="showSubpage('rules', 'rules-2')">Активность</button>
                <button class="page-nav-button" onclick="showSubpage('rules', 'rules-3')">Общение</button>
                <button class="page-nav-button" onclick="showSubpage('rules', 'rules-4')">Ивенты</button>
                <button class="page-nav-button" onclick="showSubpage('rules', 'rules-5')">Наказания</button>
            </div>
            
            <div id="rules-1" class="subpage active">
                <div class="admin-section">
                    <h3>Основные правила</h3>
                    <p>Эти правила являются фундаментом нашей семьи и обязательны для соблюдения всеми членами:</p>
                    <ul style="margin-left: 20px; color: var(--text-light); margin-top: 15px;">
                        <li>Уважение ко всем членам семьи без исключения</li>
                        <li>Запрет на оскорбления, дискриминацию и токсичное поведение</li>
                        <li>Соблюдение правил проекта Majestic RP</li>
                        <li>Запрет на читерство и использование запрещенных модификаций</li>
                        <li>Конфиденциальность внутренней информации семьи</li>
                        <li>Взаимопомощь и поддержка других членов семьи</li>
                        <li>Ответственность за свои действия и слова</li>
                    </ul>
                </div>
            </div>
            
            <div id="rules-2" class="subpage">
                <div class="admin-section">
                    <h3>Требования к активности</h3>
                    <p>Для поддержания жизнеспособности семьи установлены следующие требования:</p>
                    <ul style="margin-left: 20px; color: var(--text-light); margin-top: 15px;">
                        <li>Минимальная активность: 3 раза в неделю</li>
                        <li>Участие в обязательных семейных ивентах</li>
                        <li>Отчет о длительном отсутствии (более 3 дней)</li>
                        <li>Активное участие в жизни дискорд-сообщества</li>
                        <li>Выполнение поставленных задач и поручений</li>
                        <li>Посещение собраний семьи (1 раз в неделю)</li>
                        <li>Своевременное реагирование на важные сообщения</li>
                    </ul>
                    <p style="margin-top: 15px; color: var(--text-light);">
                        <strong>Важно:</strong> При длительном отсутствии без уважительной причины член семьи может быть переведен в статус неактивного.
                    </p>
                </div>
            </div>
            
            <div id="rules-3" class="subpage">
                <div class="admin-section">
                    <h3>Правила общения</h3>
                    <p>Для поддержания здоровой атмосферы в семье установлены правила общения:</p>
                    <ul style="margin-left: 20px; color: var(--text-light); margin-top: 15px;">
                        <li>Использование русского языка в основном чате</li>
                        <li>Соблюдение тематики каналов в Discord</li>
                        <li>Запрет на флуд, спам и оффтоп в рабочих каналах</li>
                        <li>Уважительное отношение к мнению других</li>
                        <li>Конструктивная критика вместо оскорблений</li>
                        <li>Решение конфликтов через руководство семьи</li>
                        <li>Использование соответствующих ролям каналов</li>
                        <li>Соблюдение сетевого этикета и культуры общения</li>
                    </ul>
                </div>
            </div>
            
            <div id="rules-4" class="subpage">
                <div class="admin-section">
                    <h3>Правила участия в ивентах</h3>
                    <p>Для эффективной организации мероприятий установлены следующие правила:</p>
                    <ul style="margin-left: 20px; color: var(--text-light); margin-top: 15px;">
                        <li>Обязательная регистрация на ивенты за 24 часа</li>
                        <li>Присутствие за 15 минут до начала мероприятия</li>
                        <li>Выполнение указаний организаторов и лидеров</li>
                        <li>Использование установленного снаряжения и тактик</li>
                        <li>Запрет на несанкционированные действия во время ивентов</li>
                        <li>Соблюдение регламента и временных рамок</li>
                        <li>Взаимовыручка и помощь другим участникам</li>
                        <li>Адекватная реакция на исход ивента (победа/поражение)</li>
                    </ul>
                </div>
            </div>
            
            <div id="rules-5" class="subpage">
                <div class="admin-section">
                    <h3>Система наказаний</h3>
                    <p>За нарушение правил семьи предусмотрена система наказаний:</p>
                    <ul style="margin-left: 20px; color: var(--text-light); margin-top: 15px;">
                        <li><strong>Предупреждение</strong> - за незначительные нарушения</li>
                        <li><strong>Временное ограничение прав</strong> - за повторные нарушения</li>
                        <li><strong>Понижение в статусе</strong> - за серьезные проступки</li>
                        <li><strong>Временное исключение</strong> - за грубые нарушения</li>
                        <li><strong>Постоянное исключение</strong> - за неисправимое поведение</li>
                    </ul>
                    <p style="margin-top: 15px; color: var(--text-light);">
                        <strong>Примечание:</strong> Каждая ситуация рассматривается индивидуально. Руководство семьи оставляет за собой право принимать решения с учетом всех обстоятельств.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <section id="reviews" class="content-section">
        <div class="container">
            <h2 style="text-align: center; color: var(--primary); margin-bottom: 30px;">Отзывы</h2>
            <div id="addReviewSection" style="display: none;">
                <div class="admin-section">
                    <form id="reviewForm">
                        <div class="form-group">
                            <label>Ваш отзыв:</label>
                            <textarea id="reviewText" required rows="4"></textarea>
                        </div>
                        <button type="submit" class="submit-btn">Отправить</button>
                    </form>
                </div>
            </div>
            <div id="reviewsList"></div>
        </div>
    </section>

    <section id="admin" class="content-section">
        <div class="container">
            <h2 style="text-align: center; color: var(--primary); margin-bottom: 30px;">Админка</h2>
            <div class="admin-section">
                <h3>Заявки в семью</h3>
                <div id="applicationsList"></div>
            </div>
            <div class="admin-section">
                <h3>Пользователи</h3>
                <div id="usersList"></div>
            </div>
        </div>
    </section>

    <!-- Modals -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('registerModal')">&times;</span>
            <h2 style="color: var(--primary); text-align: center; margin-bottom: 20px;">Регистрация</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label>Логин:</label>
                    <input type="text" id="regLogin" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="regEmail" required>
                </div>
                <div class="form-group">
                    <label>Пароль:</label>
                    <input type="password" id="regPassword" required>
                </div>
                <button type="submit" class="submit-btn">Зарегистрироваться</button>
            </form>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('loginModal')">&times;</span>
            <h2 style="color: var(--primary); text-align: center; margin-bottom: 20px;">Вход</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>Логин/Email:</label>
                    <input type="text" id="loginInput" required>
                </div>
                <div class="form-group">
                    <label>Пароль:</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="submit-btn">Войти</button>
            </form>
        </div>
    </div>

    <div id="tgAuthModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('tgAuthModal')">&times;</span>
            <h2 style="color: var(--primary); text-align: center; margin-bottom: 20px;">Двухфакторная аутентификация</h2>
            <p style="text-align: center; margin-bottom: 20px;">Код отправлен в ваш Telegram. Введите его ниже:</p>
            <form id="tgAuthForm">
                <div class="form-group">
                    <label>Код подтверждения:</label>
                    <input type="text" id="tgAuthCode" required maxlength="6">
                </div>
                <button type="submit" class="submit-btn">Подтвердить</button>
            </form>
            <p style="text-align: center; margin-top: 15px; font-size: 0.9em; color: var(--text-light);">
                Не получили код? <a href="#" onclick="resendTgCode()" style="color: var(--primary);">Отправить снова</a>
            </p>
        </div>
    </div>

    <div id="joinFamilyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('joinFamilyModal')">&times;</span>
            <h2 style="color: var(--primary); text-align: center; margin-bottom: 20px;">Вступление в семью</h2>
            <form id="joinFamilyForm">
                <div class="form-group">
                    <label>Ник Фамилия | Static:</label>
                    <input type="text" id="familyNickname" required>
                </div>
                <div class="form-group">
                    <label>Почему вы хотите к нам?</label>
                    <textarea id="familyReason" required rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label>Ваш Discord:</label>
                    <input type="text" id="familyDiscord" required>
                </div>
                <button type="submit" class="submit-btn">Отправить заявку</button>
            </form>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('settingsModal')">&times;</span>
            <h2 style="color: var(--primary); text-align: center; margin-bottom: 20px;">Настройки аккаунта</h2>
            <div class="admin-section">
                <h3>Telegram для двухфакторной аутентификации</h3>
                <p style="margin-bottom: 15px; color: var(--text-light);">
                    Для включения двухфакторной аутентификации введите ваш Chat ID в Telegram:
                </p>
                <form id="tgSettingsForm">
                    <div class="form-group">
                        <label>Ваш Telegram Chat ID:</label>
                        <input type="text" id="tgChatId" placeholder="Пример: 123456789">
                    </div>
                    <button type="submit" class="submit-btn">Сохранить</button>
                </form>
                <div style="margin-top: 20px; padding: 15px; background: rgba(40,40,40,0.6); border-radius: 8px;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Как получить Chat ID?</h4>
                    <ol style="margin-left: 20px; color: var(--text-light);">
                        <li>Найдите нашего бота в Telegram: <strong>@AressFamQBot</strong></li>
                        <li>Напишите ему любое сообщение</li>
                        <li>Бот автоматически ответит вам с вашим Chat ID</li>
                        <li>Скопируйте этот ID и вставьте в поле выше</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Database
        let users = JSON.parse(localStorage.getItem('users')) || [];
        let reviews = JSON.parse(localStorage.getItem('reviews')) || [];
        let applications = JSON.parse(localStorage.getItem('applications')) || [];
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        let pendingLogin = null; // Для хранения данных пользователя перед 2FA

        // Telegram Bot Configuration
        const BOT_TOKEN = '8120023422:AAEdxk58S8JOVzlaWtK294TRDJe27FcXWn0';

        // Init
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadReviews();
            if (currentUser?.role === 'admin') loadApplications();
        });

        // Auth
        function checkAuth() {
            const auth = document.getElementById('authButtons');
            const user = document.getElementById('userInfo');
            const admin = document.querySelectorAll('.admin-only');
            
            if (currentUser) {
                auth.style.display = 'none';
                user.style.display = 'flex';
                document.getElementById('userName').textContent = currentUser.login;
                document.getElementById('addReviewSection').style.display = 'block';
                
                if (currentUser.role === 'admin') {
                    admin.forEach(el => el.style.display = 'flex');
                    loadUsers();
                }
            } else {
                auth.style.display = 'flex';
                user.style.display = 'none';
                admin.forEach(el => el.style.display = 'none');
            }
        }

        // Register
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const login = document.getElementById('regLogin').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            if (users.find(u => u.login === login)) {
                showNotification('Логин занят', 'error'); return;
            }

            const user = {
                id: Date.now(), login, email, password,
                role: users.length === 0 ? 'admin' : 'user',
                registered: new Date().toISOString(),
                tgChatId: null, // Для хранения Telegram Chat ID
                twoFactorEnabled: false // Флаг включения двухфакторной аутентификации
            };

            users.push(user);
            localStorage.setItem('users', JSON.stringify(users));
            
            currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(user));
            
            showNotification('Регистрация успешна!', 'success');
            closeModal('registerModal');
            checkAuth();
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const login = document.getElementById('loginInput').value;
            const password = document.getElementById('loginPassword').value;
            
            const user = users.find(u => (u.login === login || u.email === login) && u.password === password);
            if (user) {
                // Если у пользователя включена двухфакторная аутентификация
                if (user.tgChatId && user.twoFactorEnabled) {
                    pendingLogin = user; // Сохраняем данные пользователя
                    sendTgAuthCode(user.tgChatId); // Отправляем код в Telegram
                    closeModal('loginModal');
                    openModal('tgAuthModal');
                } else {
                    // Если 2FA не включена, входим сразу
                    completeLogin(user);
                }
            } else {
                showNotification('Неверные данные', 'error');
            }
        });

        // Telegram Two-Factor Authentication
        function sendTgAuthCode(chatId) {
            // Генерируем случайный 6-значный код
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            
            // Сохраняем код для проверки
            pendingLogin.tgAuthCode = code;
            
            // Отправляем сообщение через Telegram Bot API
            const message = `🔐 Код подтверждения для входа в Aress FamQ: ${code}\n\nНикому не сообщайте этот код!`;
            
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    showNotification('Код отправлен в ваш Telegram', 'success');
                } else {
                    showNotification('Ошибка отправки кода', 'error');
                    console.error('Telegram API error:', data);
                }
            })
            .catch(error => {
                showNotification('Ошибка подключения к Telegram', 'error');
                console.error('Error sending Telegram message:', error);
            });
        }

        // Проверка кода подтверждения
        document.getElementById('tgAuthForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const enteredCode = document.getElementById('tgAuthCode').value;
            
            if (pendingLogin && enteredCode === pendingLogin.tgAuthCode) {
                completeLogin(pendingLogin);
                closeModal('tgAuthModal');
                pendingLogin = null;
            } else {
                showNotification('Неверный код подтверждения', 'error');
            }
        });

        // Повторная отправка кода
        function resendTgCode() {
            if (pendingLogin && pendingLogin.tgChatId) {
                sendTgAuthCode(pendingLogin.tgChatId);
                showNotification('Код отправлен повторно', 'success');
            }
        }

        // Завершение входа
        function completeLogin(user) {
            currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(user));
            showNotification(`Добро пожаловать, ${user.login}!`, 'success');
            checkAuth();
        }

        // Настройки Telegram
        document.getElementById('tgSettingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const chatId = document.getElementById('tgChatId').value;
            
            if (!chatId) {
                showNotification('Введите Chat ID', 'error');
                return;
            }
            
            // Проверяем, что Chat ID - это число
            if (!/^\d+$/.test(chatId)) {
                showNotification('Chat ID должен содержать только цифры', 'error');
                return;
            }
            
            // Обновляем данные пользователя
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].tgChatId = chatId;
                users[userIndex].twoFactorEnabled = true;
                localStorage.setItem('users', JSON.stringify(users));
                
                // Обновляем текущего пользователя
                currentUser = users[userIndex];
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                showNotification('Настройки сохранены! Двухфакторная аутентификация включена.', 'success');
                closeModal('settingsModal');
                
                // Отправляем тестовое сообщение
                fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: '✅ Двухфакторная аутентификация успешно настроена! Теперь при каждом входе в аккаунт вы будете получать код подтверждения в этот чат.'
                    })
                });
            }
        });

        // Join Family
        document.getElementById('joinFamilyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const app = {
                id: Date.now(),
                nickname: document.getElementById('familyNickname').value,
                reason: document.getElementById('familyReason').value,
                discord: document.getElementById('familyDiscord').value,
                status: 'pending',
                date: new Date().toISOString(),
                userId: currentUser?.id,
                userLogin: currentUser?.login || 'Гость'
            };

            applications.push(app);
            localStorage.setItem('applications', JSON.stringify(applications));
            
            showNotification('Заявка отправлена!', 'success');
            closeModal('joinFamilyModal');
            if (currentUser?.role === 'admin') loadApplications();
        });

        // Applications
        function loadApplications() {
            const list = document.getElementById('applicationsList');
            const pending = applications.filter(a => a.status === 'pending');
            
            list.innerHTML = pending.map(app => `
                <div class="user-card">
                    <p><strong>Ник:</strong> ${app.nickname}</p>
                    <p><strong>Discord:</strong> ${app.discord}</p>
                    <p><strong>Причина:</strong> ${app.reason}</p>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="submit-btn" onclick="approveApp(${app.id})" style="padding: 8px 15px;">Одобрить</button>
                        <button class="submit-btn" onclick="rejectApp(${app.id})" style="background: var(--error); padding: 8px 15px;">Отклонить</button>
                    </div>
                </div>
            `).join('');
        }

        function approveApp(id) {
            applications = applications.map(a => a.id === id ? {...a, status: 'approved'} : a);
            localStorage.setItem('applications', JSON.stringify(applications));
            showNotification('Заявка одобрена', 'success');
            loadApplications();
        }

        function rejectApp(id) {
            applications = applications.map(a => a.id === id ? {...a, status: 'rejected'} : a);
            localStorage.setItem('applications', JSON.stringify(applications));
            showNotification('Заявка отклонена', 'success');
            loadApplications();
        }

        // Users
        function loadUsers() {
            const list = document.getElementById('usersList');
            list.innerHTML = users.map(user => `
                <div class="user-card">
                    <p><strong>${user.login}</strong> (${user.role})</p>
                    <p>${user.email}</p>
                    <p>2FA: ${user.twoFactorEnabled ? '✅ Включена' : '❌ Выключена'}</p>
                    ${user.role !== 'admin' ? `
                        <button class="submit-btn" onclick="makeAdmin(${user.id})" style="padding: 8px 15px; margin-top: 10px;">
                            Сделать админом
                        </button>
                    ` : ''}
                </div>
            `).join('');
        }

        function makeAdmin(id) {
            users = users.map(u => u.id === id ? {...u, role: 'admin'} : u);
            localStorage.setItem('users', JSON.stringify(users));
            showNotification('Пользователь стал админом', 'success');
            loadUsers();
        }

        // Reviews
        function loadReviews() {
            const list = document.getElementById('reviewsList');
            const approved = reviews.filter(r => r.approved);
            list.innerHTML = approved.map(r => `
                <div class="admin-section">
                    <p><strong>${r.author}</strong> - ${new Date(r.date).toLocaleDateString()}</p>
                    <p>${r.text}</p>
                </div>
            `).join('');
        }

        document.getElementById('reviewForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const review = {
                id: Date.now(),
                author: currentUser.login,
                text: document.getElementById('reviewText').value,
                date: new Date().toISOString(),
                approved: currentUser.role === 'admin'
            };
            reviews.push(review);
            localStorage.setItem('reviews', JSON.stringify(reviews));
            showNotification('Отзыв отправлен', 'success');
            loadReviews();
        });

        // Subpage Navigation
        function showSubpage(section, subpageId) {
            // Hide all subpages in the section
            const subpages = document.querySelectorAll(`#${section} .subpage`);
            subpages.forEach(subpage => subpage.classList.remove('active'));
            
            // Show selected subpage
            document.getElementById(subpageId).classList.add('active');
            
            // Update navigation buttons
            const navButtons = document.querySelectorAll(`#${section} .page-nav-button`);
            navButtons.forEach(button => button.classList.remove('active'));
            
            // Find and activate the clicked button
            const activeButton = Array.from(navButtons).find(button => 
                button.getAttribute('onclick').includes(subpageId)
            );
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }

        // Utils
        function showNotification(message, type) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = `notification ${type} show`;
            setTimeout(() => notif.classList.remove('show'), 3000);
        }

        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function openModal(id) {
            document.getElementById(id).style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showNotification('Вы вышли', 'success');
            checkAuth();
            showSection('main');
        }

        window.onclick = function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>